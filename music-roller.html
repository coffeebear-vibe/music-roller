<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Album Roll">
  <title>Album Roll</title>
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;600;700&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0a0a;
      --surface: #161616;
      --surface2: #1e1e1e;
      --border: #2c2c2c;
      --text: #f5f5f7;
      --text2: #a1a1a6;
      --muted: #555;
      --accent: #fc3c44;
      --accent2: #ff6b6b;
      --pink: #ff2d55;
      --purple: #bf5af2;
      --green: #30d158;
      --red: #ff453a;
    }

    html, body {
      height: 100%; width: 100%;
      background: var(--bg);
      color: var(--text);
      font-family: 'Outfit', sans-serif;
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
    }

    body {
      display: flex; flex-direction: column;
      min-height: 100dvh;
      padding-top: max(env(safe-area-inset-top), 52px);
      padding-bottom: max(env(safe-area-inset-bottom), 28px);
      padding-left: 20px; padding-right: 20px;
    }

    /* â”€â”€ HEADER â”€â”€ */
    .header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 18px; flex-shrink: 0;
    }
    .header-left { display: flex; flex-direction: column; gap: 1px; }
    .header-left h1 {
      font-size: 28px; font-weight: 800; color: var(--text);
      letter-spacing: -0.03em; line-height: 1;
    }
    .header-left h1 span { color: var(--accent); }
    .header-left p {
      font-size: 11px; font-weight: 400; color: var(--text2);
      letter-spacing: 0.05em; text-transform: uppercase; margin-top: 3px;
    }
    .count-wrap {
      display: flex; flex-direction: column; align-items: center;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 16px; padding: 8px 16px;
    }
    .count-num {
      font-size: 22px; font-weight: 800; color: var(--accent);
      letter-spacing: -0.02em; line-height: 1;
    }
    .count-label { font-size: 10px; color: var(--text2); font-weight: 500; letter-spacing: 0.1em; text-transform: uppercase; margin-top: 1px; }

    /* â”€â”€ BUTTON ROW â”€â”€ */
    .btn-row { display: flex; gap: 10px; margin-bottom: 16px; flex-shrink: 0; }
    .roll-btn {
      flex: 2; padding: 17px; border-radius: 14px; border: none;
      background: var(--accent); color: #fff;
      font-family: 'Outfit', sans-serif; font-weight: 700; font-size: 15px;
      letter-spacing: 0.04em; text-transform: uppercase; cursor: pointer; outline: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.12s ease, filter 0.12s ease;
      box-shadow: 0 4px 20px rgba(252, 60, 68, 0.35);
    }
    .roll-btn:active { transform: scale(0.96); filter: brightness(0.9); }
    .roll-btn:disabled { background: var(--surface2); color: var(--muted); box-shadow: none; cursor: default; }
    .clear-btn {
      flex: 1; padding: 17px; border-radius: 14px;
      border: 1px solid var(--border); background: var(--surface2);
      color: var(--text2); font-family: 'Outfit', sans-serif;
      font-weight: 600; font-size: 13px; letter-spacing: 0.04em;
      text-transform: uppercase; cursor: pointer; outline: none;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.12s ease, background 0.12s ease;
    }
    .clear-btn:active { transform: scale(0.96); background: var(--border); }

    /* â”€â”€ MAIN CARD â”€â”€ */
    .card {
      width: 100%; background: var(--surface);
      border: 1px solid var(--border); border-radius: 22px;
      padding: 0; position: relative; overflow: hidden;
      display: flex; flex-direction: column; flex-shrink: 0;
    }
    .card-accent-bar {
      height: 3px; width: 100%;
      background: linear-gradient(90deg, var(--accent), var(--purple), var(--pink));
      opacity: 0; transition: opacity 0.4s ease; flex-shrink: 0;
    }
    .card.revealed .card-accent-bar { opacity: 1; }
    .card-inner { padding: 22px 22px 20px; }

    /* vinyl art placeholder */
    .vinyl-wrap {
      width: 72px; height: 72px; border-radius: 14px;
      background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
      border: 1px solid var(--border); display: flex; align-items: center;
      justify-content: center; font-size: 30px; flex-shrink: 0;
      position: relative; overflow: hidden;
      opacity: 0; transition: opacity 0.3s ease 0.1s;
      box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .card.revealed .vinyl-wrap { opacity: 1; }
    .vinyl-wrap::after {
      content: ''; position: absolute; inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.05), transparent);
    }

    .card-top { display: flex; gap: 16px; align-items: flex-start; }
    .card-top-text { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 4px; padding-top: 2px; }

    .pick-label {
      font-size: 10px; font-weight: 600; color: var(--accent);
      letter-spacing: 0.2em; text-transform: uppercase;
      opacity: 0; transition: opacity 0.3s ease;
    }
    .card.revealed .pick-label { opacity: 1; }

    .album-name {
      font-size: clamp(17px, 4.5vw, 22px); font-weight: 800;
      color: var(--text); line-height: 1.2; letter-spacing: -0.02em;
      opacity: 0; transform: translateY(6px);
      transition: opacity 0.3s ease 0.05s, transform 0.3s ease 0.05s;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .card.revealed .album-name { opacity: 1; transform: translateY(0); }

    .artist-name {
      font-size: 14px; font-weight: 500; color: var(--text2);
      opacity: 0; transition: opacity 0.3s ease 0.1s;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .card.revealed .artist-name { opacity: 1; }

    .year-chip {
      display: inline-flex; align-items: center;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: 6px; padding: 3px 8px;
      font-size: 11px; font-weight: 600; color: var(--text2);
      margin-top: 2px; width: fit-content;
      opacity: 0; transition: opacity 0.3s ease 0.15s;
    }
    .card.revealed .year-chip { opacity: 1; }

    .card-actions {
      display: flex; gap: 8px; margin-top: 16px;
      opacity: 0; transition: opacity 0.3s ease 0.2s;
    }
    .card.revealed .card-actions { opacity: 1; }

    .am-btn {
      flex: 1; display: flex; align-items: center; justify-content: center; gap: 7px;
      padding: 11px 14px; border-radius: 12px;
      background: linear-gradient(135deg, #fc3c44, #ff2d55);
      text-decoration: none; font-size: 12px; font-weight: 700;
      color: #fff; letter-spacing: 0.04em; text-transform: uppercase;
      box-shadow: 0 4px 16px rgba(252, 60, 68, 0.3);
      transition: transform 0.12s, filter 0.12s;
    }
    .am-btn:active { transform: scale(0.96); filter: brightness(0.9); }

    .copy-btn {
      flex: 1; display: flex; align-items: center; justify-content: center; gap: 7px;
      padding: 11px 14px; border-radius: 12px;
      background: var(--surface2); border: 1px solid var(--border);
      font-size: 12px; font-weight: 700; color: var(--text2);
      letter-spacing: 0.04em; text-transform: uppercase; cursor: pointer;
      outline: none; font-family: 'Outfit', sans-serif;
      -webkit-tap-highlight-color: transparent;
      transition: transform 0.12s, background 0.12s, color 0.15s;
      border: none;
    }
    .copy-btn:active { transform: scale(0.96); background: var(--border); }
    .copy-btn.copied { color: var(--green); }

    /* empty / shimmer */
    .card-empty {
      display: flex; flex-direction: column; align-items: center;
      justify-content: center; gap: 10px; padding: 36px 20px;
    }
    .card-empty .e-icon { font-size: 38px; opacity: 0.25; }
    .card-empty p { font-size: 13px; color: var(--text2); text-align: center; line-height: 1.5; }

    .shimmer-wrap { padding: 22px; display: none; flex-direction: column; gap: 12px; }
    .shimmer-wrap.active { display: flex; }
    .shimmer-row { display: flex; gap: 14px; align-items: flex-start; }
    .shimmer-art { width: 72px; height: 72px; border-radius: 14px; flex-shrink: 0; }
    .shimmer-lines { flex: 1; display: flex; flex-direction: column; gap: 8px; padding-top: 4px; }
    .shimmer {
      border-radius: 6px;
      background: linear-gradient(90deg, var(--surface2) 25%, var(--border) 50%, var(--surface2) 75%);
      background-size: 200% 100%; animation: shimmer 1s infinite;
    }
    .sh-sm { height: 10px; width: 35%; }
    .sh-title { height: 22px; width: 85%; }
    .sh-sub { height: 14px; width: 55%; }
    .sh-btn { height: 40px; border-radius: 12px; }
    @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }

    /* â”€â”€ STATUS â”€â”€ */
    .status-bar {
      display: flex; align-items: center; gap: 8px;
      margin-top: 10px; margin-bottom: 14px; flex-shrink: 0;
    }
    .status-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--muted); flex-shrink: 0; transition: background 0.3s;
    }
    .status-dot.ok { background: var(--green); }
    .status-dot.err { background: var(--red); }
    .status-dot.loading { background: var(--accent); animation: pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.3} }
    .status-text { font-size: 11px; color: var(--text2); }

    /* â”€â”€ RECENTS â”€â”€ */
    .recents-section { flex: 1; overflow: hidden; display: flex; flex-direction: column; min-height: 0; }
    .recents-label {
      font-size: 10px; font-weight: 600; color: var(--muted);
      letter-spacing: 0.2em; text-transform: uppercase; margin-bottom: 10px; flex-shrink: 0;
    }
    .recents-list { display: flex; flex-direction: column; gap: 8px; overflow: hidden; }
    .recent-item {
      display: flex; align-items: center; gap: 12px;
      padding: 11px 14px; background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; opacity: 0; transform: translateY(4px);
      transition: opacity 0.3s ease, transform 0.3s ease; flex-shrink: 0;
    }
    .recent-item.visible { opacity: 1; transform: translateY(0); }
    .recent-art {
      width: 42px; height: 42px; border-radius: 8px; flex-shrink: 0;
      background: linear-gradient(135deg, var(--surface2), var(--border));
      display: flex; align-items: center; justify-content: center; font-size: 18px;
    }
    .recent-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 1px; }
    .recent-album { font-size: 13px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .recent-artist { font-size: 11px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .recent-btns { display: flex; flex-direction: column; gap: 4px; align-items: flex-end; flex-shrink: 0; }
    .recent-am {
      font-size: 10px; font-weight: 700; color: var(--accent);
      text-decoration: none; letter-spacing: 0.04em; text-transform: uppercase;
      padding: 3px 0;
    }
    .recent-copy {
      font-size: 10px; font-weight: 600; color: var(--text2);
      cursor: pointer; background: none; border: none; padding: 3px 0;
      font-family: 'Outfit', sans-serif; letter-spacing: 0.04em; text-transform: uppercase;
      -webkit-tap-highlight-color: transparent;
      transition: color 0.2s;
    }
    .recent-copy.copied { color: var(--green); }
  </style>
</head>
<body>

  <div class="header">
    <div class="header-left">
      <h1>Album<span>Roll</span></h1>
      <p>Unlistened picks</p>
    </div>
    <div class="count-wrap">
      <div class="count-num" id="countNum">â€”</div>
      <div class="count-label">left</div>
    </div>
  </div>

  <div class="btn-row">
    <button class="roll-btn" id="rollBtn" onclick="roll()">â™« Roll</button>
    <button class="clear-btn" onclick="clearAll()">Clear</button>
  </div>

  <div class="card" id="card">
    <div class="card-accent-bar"></div>

    <!-- Shimmer -->
    <div class="shimmer-wrap" id="shimmerWrap">
      <div class="shimmer-row">
        <div class="shimmer shimmer-art"></div>
        <div class="shimmer-lines">
          <div class="shimmer sh-sm"></div>
          <div class="shimmer sh-title"></div>
          <div class="shimmer sh-sub"></div>
        </div>
      </div>
      <div class="shimmer sh-btn"></div>
    </div>

    <!-- Empty -->
    <div class="card-empty" id="cardEmpty">
      <div class="e-icon">ðŸŽµ</div>
      <p>Tap Roll to discover a random<br>album from your list</p>
    </div>

    <!-- Result -->
    <div class="card-inner" id="cardResult" style="display:none;">
      <div class="card-top">
        <div class="vinyl-wrap" id="vinylArt">ðŸŽµ</div>
        <div class="card-top-text">
          <div class="pick-label" id="pickLabel">Pick #1</div>
          <div class="album-name" id="albumName"></div>
          <div class="artist-name" id="artistName"></div>
          <div class="year-chip" id="yearChip"></div>
        </div>
      </div>
      <div class="card-actions">
        <a class="am-btn" id="amBtn" href="#" target="_self">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
          Apple Music
        </a>
        <button class="copy-btn" id="copyBtn">ðŸ“‹ Copy</button>
      </div>
    </div>
  </div>

  <div class="status-bar">
    <div class="status-dot" id="statusDot"></div>
    <div class="status-text" id="statusText">Loading your listâ€¦</div>
  </div>

  <div class="recents-section">
    <div class="recents-label">Recent picks</div>
    <div class="recents-list" id="recentsList">
      <div class="recent-item visible" style="opacity:0.3; border-style:dashed;">
        <span style="font-size:11px; color:var(--text2);">No picks yet</span>
      </div>
    </div>
  </div>

  <script>
    const SHEET_ID = '1B3aU-_MclDi_XdBw_1t4ohkduVTpz8LD';
    const JSON_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=1279772250`;

    const card        = document.getElementById('card');
    const shimmerWrap = document.getElementById('shimmerWrap');
    const cardEmpty   = document.getElementById('cardEmpty');
    const cardResult  = document.getElementById('cardResult');
    const pickLabel   = document.getElementById('pickLabel');
    const albumName   = document.getElementById('albumName');
    const artistName  = document.getElementById('artistName');
    const yearChip    = document.getElementById('yearChip');
    const amBtn       = document.getElementById('amBtn');
    const copyBtn     = document.getElementById('copyBtn');
    const countNum    = document.getElementById('countNum');
    const statusDot   = document.getElementById('statusDot');
    const statusText  = document.getElementById('statusText');
    const rollBtn     = document.getElementById('rollBtn');
    const recentsList = document.getElementById('recentsList');

    let recents = [];
    let rolling = false;

    // Emoji art based on first letter
    function getArt(name) {
      const emojis = ['ðŸŽ¸','ðŸŽ¹','ðŸ¥','ðŸŽ·','ðŸŽº','ðŸŽ»','ðŸª•','ðŸŽ¼','ðŸŽ¤','ðŸŽ§','ðŸŽµ','ðŸŽ¶','ðŸª—','ðŸª˜'];
      const i = (name?.charCodeAt(0) || 0) % emojis.length;
      return emojis[i];
    }

    function setStatus(state, msg) {
      statusDot.className = 'status-dot' + (state ? ' ' + state : '');
      statusText.textContent = msg;
    }

    async function fetchAlbums() {
      setStatus('loading', 'Fetching your listâ€¦');
      try {
        const res = await fetch(JSON_URL + '&t=' + Date.now());
        if (!res.ok) throw new Error('Network error');
        const text = await res.text();
        const json = JSON.parse(text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*?)\);/)[1]);
        const rows = json.table.rows;

        // Col A=0 (listened), Col B=1 (year), Col C=2 (artist), Col D=3 (album), Col E=4 (ignore)
        const unlistened = rows.filter(row => {
          const heard = row.c[0]?.v;
          return heard !== true && heard !== 'TRUE';
        }).map(row => ({
          year:   row.c[1]?.v?.toString().trim() || '',
          artist: row.c[2]?.v?.toString().trim() || '',
          album:  row.c[3]?.v?.toString().trim() || '',
        })).filter(a => a.album);

        countNum.textContent = unlistened.length;

        if (unlistened.length === 0) {
          setStatus('ok', 'You\'ve listened to everything! ðŸŽ‰');
          rollBtn.disabled = true;
          return null;
        }

        setStatus('ok', `${unlistened.length} unlistened albums`);
        rollBtn.disabled = false;
        return unlistened;
      } catch(e) {
        console.error(e);
        setStatus('err', 'Couldn\'t load sheet â€” check sharing settings');
        rollBtn.disabled = false;
        return null;
      }
    }

    function copyAlbum(album, btn) {
      const query = encodeURIComponent(album.album.trim());
      const amUrl = `https://music.apple.com/search?term=${query}`;
      const parts = [`ðŸŽµ ${album.album}`, `ðŸŽ¤ ${album.artist}`];
      if (album.year) parts.push(`ðŸ“… ${album.year}`);
      parts.push(`ðŸŽ§ ${amUrl}`);
      navigator.clipboard.writeText(parts.join('\n')).then(() => {
        const orig = btn.innerHTML;
        btn.innerHTML = 'âœ“ Copied!';
        btn.classList.add('copied');
        setTimeout(() => { btn.innerHTML = orig; btn.classList.remove('copied'); }, 2000);
      });
    }

    function showResult(album) {
      card.classList.remove('revealed');
      shimmerWrap.classList.remove('active');
      cardEmpty.style.display = 'none';
      cardResult.style.display = 'block';

      const art = getArt(album.album);
      document.getElementById('vinylArt').textContent = art;
      pickLabel.textContent  = `Pick #${recents.length + 1}`;
      albumName.textContent  = album.album;
      artistName.textContent = album.artist;
      yearChip.textContent   = album.year || '';
      yearChip.style.display = album.year ? 'inline-flex' : 'none';

      const query = encodeURIComponent(album.album.trim());
      amBtn.href = `https://music.apple.com/search?term=${query}`;
      copyBtn.onclick = () => copyAlbum(album, copyBtn);

      requestAnimationFrame(() => requestAnimationFrame(() => card.classList.add('revealed')));

      recents.unshift(album);
      if (recents.length > 3) recents.pop();
      renderRecents();
    }

    function renderRecents() {
      recentsList.innerHTML = '';
      if (recents.length === 0) {
        recentsList.innerHTML = `<div class="recent-item visible" style="opacity:0.3;border-style:dashed;"><span style="font-size:11px;color:var(--text2);">No picks yet</span></div>`;
        return;
      }
      recents.forEach((r, i) => {
        const query = encodeURIComponent(r.album.trim());
        const el = document.createElement('div');
        el.className = 'recent-item';
        el.innerHTML = `
          <div class="recent-art">${getArt(r.album)}</div>
          <div class="recent-info">
            <span class="recent-album">${r.album}</span>
            <span class="recent-artist">${r.artist}${r.year ? ' Â· ' + r.year : ''}</span>
          </div>
          <div class="recent-btns">
            <a class="recent-am" href="https://music.apple.com/search?term=${query}">Music â†—</a>
            <button class="recent-copy">ðŸ“‹ Copy</button>
          </div>`;
        const copyEl = el.querySelector('.recent-copy');
        copyEl.onclick = () => copyAlbum(r, copyEl);
        recentsList.appendChild(el);
        setTimeout(() => el.classList.add('visible'), i * 60);
      });
    }

    function clearAll() {
      recents = [];
      card.classList.remove('revealed');
      shimmerWrap.classList.remove('active');
      cardEmpty.style.display = 'flex';
      cardResult.style.display = 'none';
      renderRecents();
    }

    async function roll() {
      if (rolling) return;
      rolling = true;
      rollBtn.disabled = true;

      card.classList.remove('revealed');
      cardEmpty.style.display = 'none';
      cardResult.style.display = 'none';
      shimmerWrap.classList.add('active');

      const albums = await fetchAlbums();

      if (!albums || albums.length === 0) {
        shimmerWrap.classList.remove('active');
        cardEmpty.style.display = 'flex';
        rolling = false;
        return;
      }

      await new Promise(r => setTimeout(r, 500));

      const pick = albums[Math.floor(Math.random() * albums.length)];
      shimmerWrap.classList.remove('active');
      showResult(pick);

      if (navigator.vibrate) navigator.vibrate(12);
      rolling = false;
      rollBtn.disabled = false;
    }

    fetchAlbums();
  </script>
</body>
</html>
